name: Telegram Notifications

on:
  pull_request:
    types: [opened, closed]
  issues:
    types: [opened]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
    - name: Notify on Telegram
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        CHAT_ID: ${{ secrets.CHAT_ID }}
      run: |
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          if [ "${{ github.event.action }}" = "opened" ]; then
            MESSAGE="üîî A new pull request has been opened: #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }} by ${{ github.event.pull_request.user.login }}. [View Pull Request](${{ github.event.pull_request.html_url }})"
          elif [ "${{ github.event.action }}" = "closed" ]; then
            if [ "${{ github.event.pull_request.merged }}" = "true" ]; then
              MESSAGE="‚úÖ –†–µ–∫–≤–µ—Å—Ç #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }} –ø—Ä–∏–Ω—è—Ç ${{ github.event.pull_request.user.login }}. \n[–ü—Ä–æ—Å–º–æ—Ç—Ä](${{ github.event.pull_request.html_url }})"
            else
              MESSAGE="‚ùå –†–µ–∫–≤–µ—Å—Ç #${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }} –æ—Ç–∫–ª–æ–Ω–µ–Ω ${{ github.event.pull_request.user.login }}. \n[–ü—Ä–æ—Å–º–æ—Ç—Ä](${{ github.event.pull_request.html_url }})"
            fi
          fi
        elif [ "${{ github.event_name }}" = "issues" ]; then
          if [ "${{ github.event.action }}" = "opened" ]; then
            ISSUE_RELATED_PR="No related pull request specified."
            if [[ "${{ github.event.issue.body }}" =~ #[0-9]+ ]]; then
              ISSUE_RELATED_PR="Related pull request: $BASH_REMATCH"
            fi
            MESSAGE="üìù –û—Ç–∫—Ä—ã—Ç –Ω–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å: #${{ github.event.issue.number }} - ${{ github.event.issue.title }} –æ—Ç ${{ github.event.issue.user.login }} –ø–æ —Ä–µ–∫–≤–µ—Å—Ç—É: $ISSUE_RELATED_PR. \n[–ü—Ä–æ—Å–º–æ—Ç—Ä](${{ github.event.issue.html_url }})"
          fi
        fi
        
        curl -s -X POST "https://api.telegram.org/bot${{ env.TELEGRAM_BOT_TOKEN }}/sendMessage" -d chat_id=$CHAT_ID -d text="$MESSAGE" -d parse_mode="Markdown"
